# Copyright 1999-2020 Gentoo Authors
# Distributed under the terms of the GNU General Public License v2

EAPI=7

## gost-ebuild skell.  as template. 

EGO_PN="github.com/takuzoo3868/go-msfdb"

# Autogenerated by: pentoo/scripts/ego_vendor_generator.sh , copeied to clone dir , ran. 
EGO_VENDOR=(
        "(checkme) cloud.google.com/go v0.46.3"
        "(checkme) cloud.google.com/go/bigquery v1.0.1"
        "(checkme) cloud.google.com/go/datastore v1.0.0"
        "(checkme) cloud.google.com/go/firestore v1.1.0"
        "(checkme) cloud.google.com/go/pubsub v1.0.1"
        "(checkme) cloud.google.com/go/storage v1.0.0"
        "(checkme) dmitri.shuralyov.com/gpu/mtl 666a987"
        "github.com/BurntSushi/toml v0.3.1"
        "github.com/BurntSushi/xgb 27f1227"
        "github.com/OneOfOne/xxhash v1.2.2"
        "github.com/alecthomas/template a0175ee"
        "github.com/alecthomas/units 2efee85"
        "github.com/armon/circbuf bbbad09"
        "github.com/armon/consul-api eb2c6b5"
        "github.com/armon/go-metrics f0300d1"
        "github.com/armon/go-radix 7fddfc3"
        "github.com/asaskevich/govalidator f61b66f"
        "github.com/beorn7/perks v1.0.0"
        "github.com/bgentry/speakeasy v0.1.0"
        "github.com/bketelsen/crypt v0.0.3"
        "github.com/cespare/xxhash v1.1.0"
        "github.com/cheggaaa/pb v2.0.7"
        "github.com/client9/misspell v0.3.4"
        "github.com/coreos/bbolt v1.3.2"
        "github.com/coreos/etcd v3.3.13"
        "github.com/coreos/go-semver v0.3.0"
        "github.com/coreos/go-systemd 95778df"
        "github.com/coreos/pkg 399ea9e"
        "github.com/cpuguy83/go-md2man/v2 v2.0.0"
        "github.com/davecgh/go-spew v1.1.1"
        "github.com/denisenkom/go-mssqldb 7327370"
        "github.com/dgrijalva/jwt-go v3.2.0"
        "github.com/dgryski/go-sip13 e10d5fe"
        "github.com/erikstmartin/go-testdb 8d10e4a"
        "github.com/fatih/color v1.7.0"
        "github.com/fsnotify/fsnotify v1.4.9"
        "github.com/ghodss/yaml v1.0.0"
        "github.com/go-gl/glfw e6da0ac"
        "github.com/go-kit/kit v0.8.0"
        "github.com/go-logfmt/logfmt v0.4.0"
        "github.com/go-redis/redis v6.15.8"
        "github.com/go-sql-driver/mysql v1.4.1"
        "github.com/go-stack/stack v1.8.0"
        "github.com/gogo/protobuf v1.2.1"
        "github.com/golang-sql/civil cb61b32"
        "github.com/golang/glog 23def4e"
        "github.com/golang/groupcache 5b532d6"
        "github.com/golang/mock v1.3.1"
        "github.com/golang/protobuf v1.4.2"
        "github.com/google/btree v1.0.0"
        "github.com/google/go-cmp v0.4.0"
        "github.com/google/martian v2.1.0"
        "github.com/google/pprof 54271f7"
        "github.com/google/renameio v0.1.0"
        "github.com/googleapis/gax-go/v2 v2.0.5"
        "github.com/gopherjs/gopherjs 0766667"
        "github.com/gorilla/websocket v1.4.2"
        "github.com/grpc-ecosystem/go-grpc-middleware v1.0.0"
        "github.com/grpc-ecosystem/go-grpc-prometheus v1.2.0"
        "github.com/grpc-ecosystem/grpc-gateway v1.9.0"
        "github.com/hashicorp/consul/api v1.1.0"
        "github.com/hashicorp/consul/sdk v0.1.1"
        "github.com/hashicorp/errwrap v1.0.0"
        "github.com/hashicorp/go-cleanhttp v0.5.1"
        "github.com/hashicorp/go-immutable-radix v1.0.0"
        "github.com/hashicorp/go-msgpack v0.5.3"
        "github.com/hashicorp/go-multierror v1.0.0"
        "github.com/hashicorp/go-rootcerts v1.0.0"
        "github.com/hashicorp/go-sockaddr v1.0.0"
        "github.com/hashicorp/go-syslog v1.0.0"
        "github.com/hashicorp/go-uuid v1.0.1"
        "github.com/hashicorp/go.net v0.0.1"
        "github.com/hashicorp/golang-lru v0.5.1"
        "github.com/hashicorp/hcl v1.0.0"
        "github.com/hashicorp/logutils v1.0.0"
        "github.com/hashicorp/mdns v1.0.0"
        "github.com/hashicorp/memberlist v0.1.3"
        "github.com/hashicorp/serf v0.8.2"
        "github.com/hpcloud/tail v1.0.0"
        "github.com/inconshreveable/log15 b30bc20"
        "github.com/inconshreveable/mousetrap v1.0.0"
        "github.com/jinzhu/gorm v1.9.12"
        "github.com/jinzhu/inflection v1.0.0"
        "github.com/jinzhu/now v1.0.1"
        "github.com/jonboulle/clockwork v0.1.0"
        "github.com/json-iterator/go v1.1.6"
        "github.com/jstemmer/go-junit-report af01ea7"
        "github.com/jtolds/gls v4.20.0"
        "github.com/julienschmidt/httprouter v1.2.0"
        "github.com/k0kubun/colorstring 9440f19"
        "github.com/k0kubun/pp v3.0.1"
        "github.com/kisielk/errcheck v1.1.0"
        "github.com/kisielk/gotool v1.0.0"
        "github.com/konsorten/go-windows-terminal-sequences v1.0.1"
        "github.com/kr/logfmt b84e30a"
        "github.com/kr/pretty v0.1.0"
        "github.com/kr/pty v1.1.1"
        "github.com/kr/text v0.1.0"
        "github.com/labstack/echo v3.3.10"
        "github.com/labstack/gommon v0.3.0"
        "github.com/lib/pq v1.1.1"
        "github.com/magiconair/properties v1.8.1"
        "github.com/mattn/go-colorable v0.1.2"
        "github.com/mattn/go-isatty v0.0.9"
        "github.com/mattn/go-runewidth v0.0.9"
        "github.com/mattn/go-sqlite3 v2.0.3"
        "github.com/matttproud/golang_protobuf_extensions v1.0.1"
        "github.com/miekg/dns v1.0.14"
        "github.com/mitchellh/cli v1.0.0"
        "github.com/mitchellh/go-homedir v1.1.0"
        "github.com/mitchellh/go-testing-interface v1.0.0"
        "github.com/mitchellh/gox v0.4.0"
        "github.com/mitchellh/iochan v1.0.0"
        "github.com/mitchellh/mapstructure v1.1.2"
        "github.com/modern-go/concurrent bacd9c7"
        "github.com/modern-go/reflect2 v1.0.1"
        "github.com/mwitkow/go-conntrack cc309e4"
        "github.com/nxadm/tail v1.4.4"
        "github.com/oklog/ulid v1.3.1"
        "github.com/onsi/ginkgo v1.13.0"
        "github.com/onsi/gomega v1.10.1"
        "github.com/pascaldekloe/goe 57f6aae"
        "github.com/pelletier/go-toml v1.2.0"
        "github.com/pkg/errors v0.8.1"
        "github.com/pmezard/go-difflib v1.0.0"
        "github.com/posener/complete v1.1.1"
        "github.com/prometheus/client_golang v0.9.3"
        "github.com/prometheus/client_model fd36f42"
        "github.com/prometheus/common v0.4.0"
        "github.com/prometheus/procfs 5867b95"
        "github.com/prometheus/tsdb v0.7.1"
        "github.com/rogpeppe/fastuuid 6724a57"
        "github.com/rogpeppe/go-internal v1.3.0"
        "github.com/russross/blackfriday/v2 v2.0.1"
        "github.com/ryanuber/columnize 9b3edd6"
        "github.com/sclevine/agouti v3.0.0"
        "github.com/sean-/seed e2103e2"
        "github.com/shurcooL/sanitized_anchor_name v1.0.0"
        "github.com/sirupsen/logrus v1.2.0"
        "github.com/smartystreets/assertions b2de0cb"
        "github.com/smartystreets/goconvey v1.6.4"
        "github.com/soheilhy/cmux v0.1.4"
        "github.com/spaolacci/murmur3 f09979e"
        "github.com/spf13/afero v1.1.2"
        "github.com/spf13/cast v1.3.0"
        "github.com/spf13/cobra v1.0.0"
        "github.com/spf13/jwalterweatherman v1.0.0"
        "github.com/spf13/pflag v1.0.3"
        "github.com/spf13/viper v1.7.0"
        "github.com/stretchr/objx v0.1.1"
        "github.com/stretchr/testify v1.4.0"
        "github.com/subosito/gotenv v1.2.0"
        "github.com/tmc/grpc-websocket-proxy 0ad062e"
        "github.com/ugorji/go v1.1.4"
        "github.com/valyala/bytebufferpool v1.0.0"
        "github.com/valyala/fasttemplate v1.1.0"
        "github.com/xiang90/probing 43a291a"
        "github.com/xordataexchange/crypt v0.0.3"
        "(checkme) go.etcd.io/bbolt v1.3.2"
        "(checkme) go.opencensus.io v0.22.0"
        "(checkme) go.uber.org/atomic v1.4.0"
        "(checkme) go.uber.org/multierr v1.1.0"
        "(checkme) go.uber.org/zap v1.10.0"
        "(checkme) golang.org/x/crypto e7c4368"
        "(checkme) golang.org/x/exp a1ab85d"
        "(checkme) golang.org/x/image cff245a"
        "(checkme) golang.org/x/lint 1621716"
        "(checkme) golang.org/x/mobile d2bd2a2"
        "(checkme) golang.org/x/mod v0.1.0"
        "(checkme) golang.org/x/net 59133d7"
        "(checkme) golang.org/x/oauth2 0f29369"
        "(checkme) golang.org/x/sync 1122301"
        "(checkme) golang.org/x/sys fe76b77"
        "(checkme) golang.org/x/text v0.3.2"
        "(checkme) golang.org/x/time 9d24e82"
        "(checkme) golang.org/x/tools aa38f8e"
        "(checkme) golang.org/x/xerrors 9bdfabe"
        "(checkme) google.golang.org/api v0.13.0"
        "(checkme) google.golang.org/appengine v1.6.1"
        "(checkme) google.golang.org/genproto 16a3f78"
        "(checkme) google.golang.org/grpc v1.21.1"
        "(checkme) google.golang.org/protobuf v1.23.0"
        "(checkme) gopkg.in/VividCortex/ewma.v1 v1.1.1"
        "(checkme) gopkg.in/alecthomas/kingpin.v2 v2.2.6"
        "(checkme) gopkg.in/check.v1 v1.0.0"
        "(checkme) gopkg.in/cheggaaa/pb.v1 v1.0.28"
        "(checkme) gopkg.in/cheggaaa/pb.v2 v2.0.7"
        "(checkme) gopkg.in/errgo.v2 v2.1.0"
        "(checkme) gopkg.in/fatih/color.v1 v1.7.0"
        "(checkme) gopkg.in/fsnotify.v1 v1.4.7"
        "(checkme) gopkg.in/ini.v1 v1.51.0"
        "(checkme) gopkg.in/mattn/go-colorable.v0 v0.1.0"
        "(checkme) gopkg.in/mattn/go-isatty.v0 v0.0.4"
        "(checkme) gopkg.in/mattn/go-runewidth.v0 v0.0.4"
        "(checkme) gopkg.in/resty.v1 v1.12.0"
        "(checkme) gopkg.in/tomb.v1 v1.0.0"
        "(checkme) gopkg.in/yaml.v2 v2.3.0"
        "(checkme) honnef.co/go/tools v0.0.1"
        "(checkme) rsc.io/binaryregexp v0.2.0"
)

inherit golang-vcs-snapshot

DESCRIPTION="Fetch the data of metasploit-framework cve's list, Build local DB , Vuls.io scanner can use."
## Vuls.io related 
HOMEPAGE="https://github.com/takuzoo3868/go-msfdb"

SRC_URI="https://github.com/takuzoo3868/go-msfdb/archive/v${PV}.tar.gz -> ${P}.tar.gz
	${EGO_VENDOR_URI}"

KEYWORDS="~amd64 ~arm64"
LICENSE="Apache-2.0"
IUSE="policykit"
RESTRICT="mirror"
SLOT=0

RDEPEND="
	policykit? (
		acct-group/vuls
		acct-user/vuls
		sys-auth/polkit
	)"
DEPEND="
	dev-go/go-text:=
	dev-go/go-tools:=
	>=dev-lang/go-1.12"

src_prepare() {
	cp "${FILESDIR}"/msfdb-daemon.initd "${T}" || die

	if ! use policykit; then
		sed -e "s/^USER=\"vuls\"/USER=\"root\"/" \
			-e "s/^GROUP=\"vuls\"/GROUP=\"root\"/" \
			-i "${T}"/msfdb-daemon.initd || die
	fi

	eapply "${FILESDIR}"/${P}_change_default_log_dir.patch

	default
}

src_compile() {
	GOPATH="${S}:$(get_golibdir_gopath)" \
		GOCACHE="${T}/go-cache" \
		go build -v -work -x -ldflags="-X main.revision=${PV} -s -w" ./... "${EGO_PN}" || die
}

src_install() {
	GOPATH="${S}:$(get_golibdir_gopath)" \
		GOCACHE="${T}/go-cache" \
		go install -v -work -x -ldflags="-X main.revision=${PV} -s -w" ./... "${EGO_PN}" || die

	rm -rf "${S}/src/${EGO_PN}/vendor" || die
	golang_install_pkgs

	exeinto "$(get_golibdir_gopath)"/bin
	doexe bin/${PN}

	newinitd "${T}"/msfdb-daemon.initd msfdb-daemon
	newconfd "${FILESDIR}"/msfdb-daemon.confd msfdb-daemon

	if use policykit; then
		insinto "/usr/share/polkit-1/rules.d"
		doins "${FILESDIR}"/polkit/10-${PN}.rules

		insinto "/usr/share/polkit-1/actions"
		doins "${FILESDIR}"/polkit/io.vuls.pkexec.${PN}.policy

		dodir "/usr/bin"
		cat > "${D}/usr/bin/${PN}" <<-_EOF_ || die
			#!/bin/sh
			pkexec --user vuls "$(get_golibdir_gopath)/bin/${PN}" "\$@"
		_EOF_

		fperms 0755 "/usr/bin/${PN}"
	else
		dosym "$(get_golibdir_gopath)/bin/${PN}" "/usr/bin/${PN}"
	fi

	keepdir "/var/log/vuls" "/var/lib/vuls"

	dodoc src/"${EGO_PN}"/{README.md,Dockerfile}
}

pkg_postinst() {
	if use policykit; then
		chown -R vuls:vuls \
			"${EROOT%/}/var/log/vuls" || die

		chmod 0750 \
			"${EROOT%/}/var/log/vuls" || die
	fi
}
